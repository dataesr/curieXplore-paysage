name: Staging deployment

on:
  push:
    branches:
      - staging

env:
  IMAGE_NAME: curiexplore-api
  IMAGE_TAG: staging

jobs:

  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v2

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image
        run: docker build . --file Dockerfile --tag $IMAGE_NAME

      - name: Push image
        run: |
          IMAGE_ID=ghcr.io/dataesr/$IMAGE_NAME

          # Change all uppercase to lowercase
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

          echo IMAGE_ID=$IMAGE_ID

          docker tag $IMAGE_NAME $IMAGE_ID:$IMAGE_TAG
          docker push $IMAGE_ID:$IMAGE_TAG

  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: ['build']
  #   steps:
  #
  #     - name: Check Out Repo
  #       uses: actions/checkout@v2
  #
  #     - name: Deploy to Cluster
  #       id: kubectl-deploy
  #       uses: dataesr/kubectl-deploy@v1
  #       env:
  #         KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
  #       with:
  #         restart: 'curie-countries'

      # - name: Notify in slack
      #   run: |
      #     curl -X POST -H 'Content-type: application/json' --data '{"blocks": [{"type": "section", "text": {"type": "mrkdwn", "text": "Une nouvelle version de mailer a été déployée !"}, "accessory": {"type": "button", "style": "primary", "text": {"type": "plain_text", "text": "Voir le site", "emoji": true }, "value": "go-to-page", "url": "https://mailer.dataesr.ovh", "action_id": "button-action" }}]}' ${{ secrets.SLACK_WEBHOOK }}
